<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voidpass Admin</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <style>
    :root{
      --bg:#06070b;
      --panel:rgba(255,255,255,0.07);
      --panel2:rgba(255,255,255,0.05);
      --line:rgba(255,255,255,0.10);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.65);
      --good:rgba(120,255,180,0.95);
      --bad:rgba(255,120,140,0.95);
      --shadow:0 20px 60px rgba(0,0,0,0.45);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:22px;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(164,79,255,0.18), transparent 55%),
        radial-gradient(1000px 700px at 80% 10%, rgba(79,164,255,0.14), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(79,255,182,0.07), transparent 55%),
        var(--bg);
    }
    .wrap{width:min(1100px, 100%)}
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .brand{
      letter-spacing:0.28em;
      text-transform:uppercase;
      font-weight:650;
      opacity:0.9;
      font-size:14px;
    }
    .pill{
      background:var(--panel2);
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      display:flex;
      align-items:center;
      gap:10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn{
      cursor:pointer;
      user-select:none;
      border-radius:14px;
      padding:10px 14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      font-weight:600;
    }
    .btn:disabled{
      opacity:0.45;
      cursor:not-allowed;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .loginRow{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap:10px;
      margin-top:10px;
    }
    input{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,0.22);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    input::placeholder{color:rgba(255,255,255,0.45)}
    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,0.20);
      color:var(--muted);
      font-size:13px;
    }
    .status{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,0.22);
      color:var(--muted);
      font-size:13px;
    }
    .status.good{color:var(--good)}
    .status.bad{color:var(--bad)}
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 820px){
      .grid{grid-template-columns: 1fr}
      .loginRow{grid-template-columns: 1fr}
    }
    .boxTitle{
      font-size:12px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      opacity:0.8;
      margin-bottom:8px;
    }
    .big{
      font-size:22px;
      font-weight:750;
      margin:2px 0 6px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .small{font-size:13px;color:var(--muted);line-height:1.35}
    .rowline{margin-top:6px;color:var(--muted);font-size:13px}
    .divider{height:1px;background:var(--line);margin:14px 0}
    a{color:rgba(180,220,255,0.95)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">• VOIDPASS ADMIN •</div>
      <div class="pill">
        <div id="who" class="small">Not signed in</div>
        <button id="btnRefresh" class="btn" disabled>Refresh</button>
        <button id="btnLogout" class="btn" disabled>Logout</button>
      </div>
    </div>

    <div class="card">
      <div class="loginRow">
        <input id="email" type="email" autocomplete="username" placeholder="Email" />
        <input id="password" type="password" autocomplete="current-password" placeholder="Password" />
        <button id="btnLogin" class="btn">Login</button>
      </div>

      <div class="hint">
        Tip: This page only works for allowlisted organizer/admin emails.<br/>
        Allowlist lives in <span class="mono">organizer_allowlist</span> and access is enforced by RLS.
      </div>

      <div id="status" class="status">Idle.</div>

      <div class="divider"></div>

      <div class="grid">
        <div class="card">
          <div class="boxTitle">Active event</div>
          <div id="evName" class="big">—</div>
          <div id="evMeta" class="rowline mono">—</div>
        </div>

        <div class="card">
          <div class="boxTitle">Registrations</div>
          <div id="regTotal" class="big">—</div>
          <div id="regMeta" class="rowline mono">—</div>
        </div>

        <div class="card">
          <div class="boxTitle">Reveal emails</div>
          <div id="mailTotal" class="big">—</div>
          <div id="mailMeta" class="rowline mono">—</div>
        </div>

        <div class="card">
          <div class="boxTitle">Notes</div>
          <div class="small">
            If this page hangs on “Fetching…”, it means RLS blocked reads (not allowlisted) or auth isn’t ready yet.<br/><br/>
            Public site stays at <a href="/index.html">index.html</a>.
          </div>
        </div>
      </div>
    </div>

    <!-- Supabase JS (must be loaded before our script) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <script>
      // ===== CONFIG =====
      const SUPABASE_URL = "https://xhitzrnmowqeaerofion.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoaXR6cm5tb3dxZWFlcm9maW9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNDY5MjYsImV4cCI6MjA4MTgyMjkyNn0.rMRAn3-3afUE4HEA4-RJ8ZB7jiqUVY9_ItU_2461Mvk";

      // ===== CLIENT =====
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ===== UI =====
      const el = (id) => document.getElementById(id);
      const setStatus = (text, kind="") => {
        const s = el("status");
        s.className = "status" + (kind ? (" " + kind) : "");
        s.textContent = text;
      };

      const setSignedInUI = (email) => {
        el("who").textContent = email ? ("Signed in: " + email) : "Not signed in";
        const signed = !!email;
        el("btnLogout").disabled = !signed;
        el("btnRefresh").disabled = !signed;
      };

      const clearDashboard = () => {
        el("evName").textContent = "—";
        el("evMeta").textContent = "—";
        el("regTotal").textContent = "—";
        el("regMeta").textContent = "—";
        el("mailTotal").textContent = "—";
        el("mailMeta").textContent = "—";
      };

      async function requireOrganizer() {
        const { data, error } = await sb.rpc("is_organizer");
        if (error) throw new Error("Organizer check failed: " + error.message);
        if (!data) throw new Error("Organizer access required (not allowlisted).");
        return true;
      }

      async function getActiveEvent() {
        const { data, error } = await sb
          .from("events")
          .select("id,name,status,reveal_at,end_at,timezone,created_at")
          .eq("status", "active")
          .order("created_at", { ascending: false })
          .limit(1);

        if (error) throw new Error("events select failed: " + error.message);
        return (Array.isArray(data) && data.length) ? data[0] : null;
      }

      async function getRegistrationCounts(eventId) {
        const totalQ = await sb
          .from("registrations")
          .select("id", { count: "exact", head: true })
          .eq("event_id", eventId);

        if (totalQ.error) throw new Error("registrations count failed: " + totalQ.error.message);
        const total = totalQ.count ?? 0;

        const revealedQ = await sb
          .from("registrations")
          .select("id", { count: "exact", head: true })
          .eq("event_id", eventId)
          .not("reveal_sent_at", "is", null);

        if (revealedQ.error) throw new Error("registrations revealed count failed: " + revealedQ.error.message);
        const revealed = revealedQ.count ?? 0;

        const pending = Math.max(0, total - revealed);
        return { total, revealed, pending };
      }

      async function getEmailLogCounts(eventId) {
        const { data, error } = await sb
          .from("email_logs")
          .select("id,status,metadata,created_at")
          .order("created_at", { ascending: false })
          .limit(200);

        if (error) throw new Error("email_logs select failed: " + error.message);

        const rows = Array.isArray(data) ? data : [];
        const filtered = rows.filter(r => {
          const m = r.metadata || {};
          return m.event_id === eventId && m.service === "reveal_sender";
        });

        const total = filtered.length;
        const ok = filtered.filter(r => (r.status || "").toLowerCase() === "ok").length;
        const failed = filtered.filter(r => (r.status || "").toLowerCase() === "failed").length;
        const inflight = Math.max(0, total - ok - failed);

        return { total, ok, failed, inflight };
      }

      async function loadDashboard() {
        setStatus("Fetching admin dashboard…");
        clearDashboard();

        await requireOrganizer();

        const ev = await getActiveEvent();
        if (!ev) {
          el("evName").textContent = "No active event";
          el("evMeta").textContent = "status=none";
          el("regTotal").textContent = "0 total";
          el("regMeta").textContent = "revealed=0 | pending=0";
          el("mailTotal").textContent = "0 logs";
          el("mailMeta").textContent = "ok=0 | failed=0 | inflight=0";
          setStatus("Loaded. (No active event)", "good");
          return;
        }

        el("evName").textContent = ev.name || "—";
        el("evMeta").textContent =
          `status=${ev.status} | reveal_at=${ev.reveal_at} | end_at=${ev.end_at} | tz=${ev.timezone}`;

        const regs = await getRegistrationCounts(ev.id);
        el("regTotal").textContent = `${regs.total} total`;
        el("regMeta").textContent = `revealed=${regs.revealed} | pending=${regs.pending}`;

        const mails = await getEmailLogCounts(ev.id);
        el("mailTotal").textContent = `${mails.total} logs`;
        el("mailMeta").textContent = `ok=${mails.ok} | failed=${mails.failed} | inflight=${mails.inflight}`;

        setStatus("Loaded.", "good");
      }

      async function refreshAuthUI() {
        const { data: { session }, error } = await sb.auth.getSession();
        if (error) {
          setSignedInUI(null);
          setStatus("Auth error: " + error.message, "bad");
          return null;
        }
        setSignedInUI(session?.user?.email || null);
        return session;
      }

      async function init() {
        await refreshAuthUI();

        sb.auth.onAuthStateChange(async (_event, session) => {
          setSignedInUI(session?.user?.email || null);
          if (session) {
            try { await loadDashboard(); }
            catch (e) { setStatus(e.message || String(e), "bad"); }
          } else {
            clearDashboard();
            setStatus("Idle.");
          }
        });

        const { data: { session } } = await sb.auth.getSession();
        if (session) {
          try { await loadDashboard(); }
          catch (e) { setStatus(e.message || String(e), "bad"); }
        }
      }

      async function doLogin() {
        const email = (el("email").value || "").trim();
        const password = (el("password").value || "");
        if (!email || !password) {
          setStatus("Enter email + password.", "bad");
          return;
        }
        setStatus("Signing in…");
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) {
          setStatus("Login failed: " + error.message, "bad");
          return;
        }
        setSignedInUI(data?.user?.email || email);
      }

      async function doLogout() {
        setStatus("Signing out…");
        await sb.auth.signOut();
        setSignedInUI(null);
        clearDashboard();
        setStatus("Signed out.", "good");
      }

      el("btnLogin").addEventListener("click", doLogin);
      el("btnLogout").addEventListener("click", doLogout);
      el("btnRefresh").addEventListener("click", async () => {
        try { await loadDashboard(); }
        catch (e) { setStatus(e.message || String(e), "bad"); }
      });

      ["email", "password"].forEach(id => {
        el(id).addEventListener("keydown", (e) => {
          if (e.key === "Enter") doLogin();
        });
      });

      init().catch(e => setStatus("Init error: " + (e.message || String(e)), "bad"));
    </script>
  </div>
</body>
</html>
