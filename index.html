<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>THE VOID</title>
  <style>
    :root {
      --bg: #0b0b0b;
      --panel: rgba(255,255,255,0.06);
      --panelBorder: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --danger: #ff5a5f;
      --ok: #2ee59d;
      --btn: rgba(255,255,255,0.10);
      --btnBorder: rgba(255,255,255,0.20);
      --btnHover: rgba(255,255,255,0.14);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 700px at 50% 20%, rgba(255,255,255,0.06), transparent 60%),
                  radial-gradient(900px 900px at 10% 90%, rgba(255,255,255,0.03), transparent 60%),
                  var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: grid;
      place-items: center;
      padding: 18px;
    }
    .wrap {
      width: 100%;
      max-width: 520px;
      text-align: center;
    }
    .brand {
      font-weight: 900;
      letter-spacing: 0.14em;
      font-size: 22px;
      margin-bottom: 10px;
      user-select: none;
    }
    .sub {
      margin: 0;
      color: var(--muted);
      line-height: 1.5;
      font-size: 14px;
    }
    .panel {
      margin-top: 18px;
      padding: 18px 16px;
      background: var(--panel);
      border: 1px solid var(--panelBorder);
      border-radius: 16px;
      backdrop-filter: blur(10px);
    }
    label {
      display: block;
      text-align: left;
      font-size: 12px;
      color: var(--muted);
      margin: 14px 0 6px;
    }
    input {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    input:focus {
      border-color: rgba(255,255,255,0.30);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.06);
    }
    .btn {
      width: 100%;
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--btnBorder);
      background: var(--btn);
      color: var(--text);
      cursor: pointer;
      font-weight: 800;
      letter-spacing: 0.04em;
      transition: background 150ms ease, transform 120ms ease;
    }
    .btn:hover { background: var(--btnHover); }
    .btn:active { transform: translateY(1px); }
    .msg {
      display: none;
      margin-top: 14px;
      font-size: 13px;
      line-height: 1.5;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      text-align: left;
    }
    .msg.ok { border-color: rgba(46,229,157,0.35); color: rgba(46,229,157,0.95); }
    .msg.bad { border-color: rgba(255,90,95,0.35); color: rgba(255,90,95,0.95); }
    .hint {
      margin-top: 12px;
      color: rgba(255,255,255,0.52);
      font-size: 12px;
      line-height: 1.45;
    }

    /* ===== Cinematic final seconds overlay ===== */
    .void-overlay{
      position:fixed;inset:0;z-index:9999;pointer-events:none;
      background:#000;
      opacity:0;
      clip-path:circle(0% at 50% 50%);
      transition:opacity 250ms ease;
    }
    .void-overlay.is-arming{opacity:1;}
    .void-overlay.is-armed{
      opacity:1;
      clip-path:circle(150% at 50% 50%);
      transition:clip-path 1200ms ease, opacity 250ms ease;
    }
    .void-overlay__text{
      position:absolute;inset:0;display:grid;place-items:center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight:800;
      letter-spacing:0.6px;
      font-size:clamp(22px, 3.3vw, 38px);
      color:rgba(255,255,255,0.92);
      opacity:0;
      transform:translateY(8px);
      transition:opacity 700ms ease, transform 700ms ease;
      text-align:center;
      padding:0 18px;
    }
    .void-overlay.is-armed .void-overlay__text{opacity:1;transform:translateY(0);}
    .void-overlay__sub{
      display:block;
      margin-top:10px;
      font-size:clamp(14px, 2.2vw, 18px);
      font-weight:600;
      letter-spacing:0.4px;
      color:rgba(255,255,255,0.72);
    }

    @media (prefers-reduced-motion: reduce){
      .void-overlay,.void-overlay__text{transition:none !important;}
      .void-overlay.is-armed{clip-path:none;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">THE VOID</div>
    <p class="sub">Register for access.<br/>Location unlocks at <strong id="revealText">—</strong>.</p>
    <p class="sub" id="countdown" style="margin-top:6px;"></p>

    <div class="panel">
      <form id="regForm">
        <label for="fullName">Full name</label>
        <input id="fullName" name="fullName" autocomplete="name" required />

        <label for="email">Email</label>
        <input id="email" name="email" type="email" autocomplete="email" required />

        <button class="btn" id="submitBtn" type="submit">Register</button>

        <div class="msg ok" id="okMsg"></div>
        <div class="msg bad" id="badMsg"></div>
      </form>

      <div class="hint" id="hintText">
        You’ll receive the location by email at reveal time. Check spam if you don’t see it.
      </div>
    </div>
  </div>

  <!-- Cinematic final seconds overlay -->
  <div id="voidOverlay" class="void-overlay" aria-hidden="true">
    <div class="void-overlay__text" id="voidOverlayText">
      The void has taken…
      <span class="void-overlay__sub">It remains.</span>
    </div>
  </div>

  <script>
    // ===== CONFIG (Browser) =====
    const SUPABASE_URL = "https://xhitzrnmowqeaerofion.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXV...CI6MjA4MTgyMjkyNn0.rMRAn3-3afUE4HEA4-RJ8ZB7jiqUVY9_ItU_2461Mvk";

    // Edge function endpoint:
    const REGISTER_URL = `${SUPABASE_URL}/functions/v1/register`;

    // Supabase REST endpoint to fetch the active event
    // (RLS is disabled in your demo environment, so anon can read.)
    const ACTIVE_EVENT_URL =
      `${SUPABASE_URL}/rest/v1/events?status=eq.active&order=created_at.desc&limit=1&select=id,name,reveal_at,timezone`;

    const form = document.getElementById("regForm");
    const okMsg = document.getElementById("okMsg");
    const badMsg = document.getElementById("badMsg");
    const submitBtn = document.getElementById("submitBtn");

    const revealTextEl = document.getElementById("revealText");
    const countdownEl = document.getElementById("countdown");
    const hintTextEl = document.getElementById("hintText");

    function show(el) { el.style.display = "block"; }
    function hide(el) { el.style.display = "none"; }

    function setOk(msg) {
      okMsg.textContent = msg;
      show(okMsg);
    }

    function setBad(msg) {
      badMsg.textContent = msg;
      show(badMsg);
    }

    // ===== Reveal time + countdown (event-driven) =====
    let revealTimer = null;

    // ===== Cinematic overlay state =====
    const overlayEl = document.getElementById("voidOverlay");
    const LS_EVENT_ID_KEY = "void_last_event_id";
    const LS_LATCH_KEY = "void_overlay_latched_for_event";
    let currentActiveEventId = null;

    function armVoidOverlay() {
      if (!overlayEl) return;
      if (!overlayEl.classList.contains("is-arming")) {
        overlayEl.classList.add("is-arming");
      }
      // expand on next paint
      requestAnimationFrame(() => overlayEl.classList.add("is-armed"));
    }

    function disarmVoidOverlay() {
      if (!overlayEl) return;
      overlayEl.classList.remove("is-armed", "is-arming");
    }

    function setOverlayLatched(eventId, latched) {
      if (!eventId) return;
      if (latched) localStorage.setItem(LS_LATCH_KEY, eventId);
      else localStorage.removeItem(LS_LATCH_KEY);
    }

    function isOverlayLatchedForEvent(eventId) {
      return localStorage.getItem(LS_LATCH_KEY) === eventId;
    }

    function formatRevealTime(dateObj, tz) {
      // Show day + time in the event timezone (falls back to browser timezone)
      const opts = {
        weekday: "short",
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      };
      if (tz) opts.timeZone = tz;
      return dateObj.toLocaleString(undefined, opts);
    }

    function startCountdown(revealAtDate, tz) {
      if (revealTimer) clearInterval(revealTimer);

      function tick() {
        const now = new Date();
        const diffMs = revealAtDate - now;

        // Seconds remaining until reveal
        const totalSeconds = Math.floor(diffMs / 1000);

        // Final seconds cinematic: fade to black from center and keep it latched after zero
        if (totalSeconds <= 5) {
          armVoidOverlay();
        }

        if (diffMs <= 0) {
          countdownEl.textContent = "Reveal is happening now — check your email.";
          if (currentActiveEventId) setOverlayLatched(currentActiveEventId, true);
          armVoidOverlay();
          clearInterval(revealTimer);
          revealTimer = null;
          return;
        }

        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const pad2 = (n) => String(n).padStart(2, "0");
        const hh = pad2(hours);
        const mm = pad2(minutes);
        const ss = pad2(seconds);

        countdownEl.textContent = days > 0
          ? `Location reveals in ${days}d ${hh}h ${mm}m ${ss}s`
          : `Location reveals in ${hh}h ${mm}m ${ss}s`;
      }

      tick();
      revealTimer = setInterval(tick, 1000);
    }

    async function loadActiveEventAndStartTimer() {
      try {
        // Show placeholders while loading
        revealTextEl.textContent = "loading…";
        countdownEl.textContent = "";

        const res = await fetch(ACTIVE_EVENT_URL, {
          method: "GET",
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
          }
        });

        if (!res.ok) {
          revealTextEl.textContent = "soon";
          countdownEl.textContent = "";
          return;
        }

        const rows = await res.json();
        const ev = rows && rows.length ? rows[0] : null;

        if (!ev) {
          revealTextEl.textContent = "soon";
          countdownEl.textContent = "";
          return;
        }

        // Reset overlay latch when the active event changes
        const lastId = localStorage.getItem(LS_EVENT_ID_KEY);
        if (ev.id && ev.id !== lastId) {
          localStorage.setItem(LS_EVENT_ID_KEY, ev.id);
          currentActiveEventId = ev.id;
          setOverlayLatched(ev.id, false);
          disarmVoidOverlay();
        }
        if (ev.id) currentActiveEventId = ev.id;

        // If we already latched for this active event (reveal hit zero previously), keep overlay on
        if (ev.id && isOverlayLatchedForEvent(ev.id)) {
          armVoidOverlay();
        }

        const tz = ev.timezone || "Australia/Sydney";
        const revealAtDate = new Date(ev.reveal_at);

        // If parsing fails, don't crash the page
        if (Number.isNaN(revealAtDate.getTime())) {
          revealTextEl.textContent = "soon";
          countdownEl.textContent = "";
          return;
        }

        revealTextEl.textContent = formatRevealTime(revealAtDate, tz);
        startCountdown(revealAtDate, tz);
      } catch (err) {
        console.log("Failed to load active event:", err);
        revealTextEl.textContent = "soon";
        countdownEl.textContent = "";
      }
    }

    // ===== Registration form submit =====
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(okMsg);
      hide(badMsg);

      submitBtn.disabled = true;
      submitBtn.textContent = "Registering…";

      const fullName = document.getElementById("fullName").value.trim();
      const email = document.getElementById("email").value.trim();

      try {
        const res = await fetch(REGISTER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fullName, email })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          const msg = data && data.error ? data.error : "Registration failed.";
          setBad(msg);
          submitBtn.disabled = false;
          submitBtn.textContent = "Register";
          return;
        }

        setOk("Registered. Check your email at reveal time.");
        form.reset();
      } catch (err) {
        console.log("Registration error:", err);
        setBad("Registration failed. Please try again.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Register";
      }
    });

    // ===== Kick off =====
    loadActiveEventAndStartTimer();
    // Refresh active event every 15 seconds (lets page recover if organiser swaps events)
    setInterval(loadActiveEventAndStartTimer, 15000);
  </script>
</body>
</html>
